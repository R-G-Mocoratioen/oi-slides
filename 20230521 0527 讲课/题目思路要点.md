## CF1542C

注意到，$x=\sum_{i\le x}1$。

故 $f(n)=\sum_{i\le f(n)}1$。

而 $\sum_{i=1}^n f(i)=\sum_{i=1}^n \sum_{j\le f(i)}1=\sum_{j}\sum_{i=1}^n [f(i)\ge j]$。

考虑 $f(i)\ge j$ 是什么意思，就是 $1,2,\dots,j-1$ 都能整除 $i$，也就是 $lcm(1,2,\dots,j-1)$ 能整除 $i$。

而 $n$ 以内的 $f(i)\ge j$ 的个数就是 $n$ 以内这个东西的倍数的个数，就是 $n/lcm$。

所以 $j$ 的范围也不会太大，暴力枚举即可。

## CF1696E

$$
\sum_{i=0}^n \sum_{j=0}^{a_i} \binom{i+j}{j}
\\
=\sum_{i=0}^n \binom{i+a_i+1}{a_i+1}
$$

## 链上二次求和

差分成 $\le r$ 的减去 $\le l-1$ 的。不妨设要算 $\le R$ 的。

链上长度 $=len$ 的区间和，考虑 $a_i$ 被算了几次。

如果 $len\le n/2$，那在 $i\in [1,len]$ 的会被算 $i$ 次，在 $[len+1,n-len]$ 的会被算 $len$ 次，在 $[n-len+1,n]$ 的会被算 $n-i+1$ 次。 

如果 $R\le n/2$，则 $a_i$ 在 $i\in [1,R]$ 的会被算 $\sum_{1\le j\le i}j+i\times (R-i)$ 次；$[R+1,n-R]$ 的会被算 $\sum_{i=1}^R i$ 次；最后一部分同理。

如果 $R>n/2$，把 $[n/2+1,R]$ 长度的单独处理。注意到 $len$ 的答案和 $n-len+1$ 的答案是一样的，故翻转之后其实也能化归到前一种情况。

据此维护 $a_i,a_ii,a_ii^2$ 等的和即可。

## P6620

$$
\sum_{k=0}^n \sum_{i=0}^m a_ik^ix^k\binom nk
\\
=\sum_{k=0}^n \sum_{i=0}^m a_i\sum_{j=0}^iS2(i,j)\binom kjj!x^k\binom nk
\\
=\sum_{k=0}^n\binom nk \sum_{j=0}^mj!\sum_{i=j}^m a_iS2(i,j)\binom kjx^k
\\
=\sum_{k=0}^n\binom nk \sum_{j=0}^mj!A_j\binom kjx^k
\\
=\sum_{j=0}^m A_jj!\sum_{k\le n}\binom nk\binom kjx^k
\\
=\sum_{j=0}^m A_jj!\sum_{k\le n}\binom nj\binom{n-j}{k-j}x^k
\\
=\sum_{j=0}^m A_jj!\binom njx^j\sum_{k\le n-j}\binom{n-j}{k}x^k
\\
=\sum_{j=0}^m A_jj!\binom njx^j(x+1)^{n-j}
$$

## P4827

设 $f(i,j)$ 表示 $i$ 到子树内所有路径的长度选 $k$ 的和。

$f(i,0)=1$，转移 $f(x,i)+f(y,i)+f(y,i-1)\to f'(x,i)$。

设 $g(i,j)$ 表示 $i$ 到所有点，包括内外，路径的长度选 $k$ 的和。

$g(1)=f(1)$。

从 $fa$ 推向 $son$：先去除 $son$ 的贡献，再把 $fa$ 加上来。

## CF1097G, P4071

略。

## P7961

注意到，如果知道了 $a_i$ 选了 $cnt_i$ 个，则方案数为 $n!/\prod (cnt_i!)$。

从低位到高位 dp，设 $dp(i,j,k,l)$ 表示做完了 $0\sim i-1$ 位，其中有 $j$ 个 1，当前选了 $k$ 个数（最终要选 $n$ 个），当前选的数往上的进位为 $l\times 2^{i-1}$ 的权值和（某一位选 $p$ 个，权值为 $1/(p!)$）。

## AGC018E

问题问的是，从第一个矩形里选一个点 $A$，第二个矩形里选一个点 $B$，第三个矩形里选一个点 $C$，$A\to B\to C$ 的方案数之和。

考虑固定 $B$，算 $A\to B$，$B\to C$ 的方案数之和。

一个点到一个以其为左下角矩形的方案数，也即
$$
\sum_{0\le i\le r_1}\sum_{0\le j\le r_2}\binom {i+j}i
\\
=\sum_{0\le i\le r_1}\binom{i+r_2+1}{i+1}
\\
=\binom{i+r_2+2}{r_2+1}-1
$$
用二维前缀和，可以把 -1 消掉，并且把到一个任意矩形的方案数变成到四个点的方案数。

右上和左下，处理方式一样的。

然后再把中间矩形内枚举点，改为枚举出点和入点，计算 $(x+y)$ 之差并求和。

时间复杂度是线性，带有 16 的常数。

## P7116

考虑对每一轮的每一步分别算贡献，贡献是 $\prod len_i$ 的形式。

注意到从第三轮开始，某一步时最大前缀和，就是上一轮这一步的最大前缀和加上全局和，所以是一个关于轮数 $x$ 的多项式。

据此，可以暴力求出多项式，然后算自然数幂和。

## CF995F

设 $f(x,i)$ 为 $x$ 号点工资为 $i$，子树内的方案数，答案关于 $i$ 是 $n$ 次多项式。

## LOJ6024

多次前缀和就是多次把多项式次数加一。

## P4463

$f(i,j)$ 从小到大第 $i$ 个数为 $j$ 的方案数，答案关于 $j$ 是 $2i$ 次多项式。

## ARC118F

正着 dp 的话，设 $f(i,j)$ 表示 $a_i=j$ 前 $i$ 个的方案数，可以发现 $f$ 转移跟下取整有关。

但是倒着 dp，就能插值了！设 $f(i,j)$ 表示 $a_i=j$，$[i,n]$ 方案数，则 $f$ 的转移其实就是求前缀和（“前缀和”是指，把第二维下标翻转，只看 $[1,m/\prod a_i]$ 内的数），跟“倍数”有关（注意 推论 2）！

还需要注意实现细节：存下来多项式在 $[1,n]$ 的点值（特别地，值域上限不到 $n$ 直接暴力 dp 就行），然后跳过连续的大段 1（转移方法是：插值出后 $n$ 个，然后不停做前缀和，再插值回来）。

用线性插值，复杂度 $O(n^2\log m)$。

## 省选 Day1 T2

第一问题意就是，对于树上的每一条链，求出下面问题的答案之和：

- 有多少种填数方案，使得链上最大值 - 最小值 $\le K$。

首先，有一个容斥：最大值 - 最小值 $\le K$ 的方案数，等于所有数都属于某个长度为 $K$ 的区间的方案数，减去所有数都属于某个长度为 $K-1$ 的区间的方案数（考虑某个方案被算了多少次来理解，这里“某个”是指取遍所有整数）。

考虑“所有数都属于 $[L,L+K]$ 的方案数”对 $L$ 求和怎么做，实际上就是把所有点权区间对这个区间左端点取 max 右端点取 min 然后长度乘起来（树上就是长度乘积和）。

如果把 $L,L+K$ 触碰到端点的情况分段，每一段内部，每个点的权值数量，相对于 $L$，是个一次函数。则链上乘起来，是不超过 $n$ 次函数；**常数**个 $n$ 次函数加起来，还是 $n$ 次函数。故求出这个 $n$ 次函数的任意 $n+2$ 项，再插值求出其前缀和即可。

如果看所有权值之和，就是把链上一个点的一次函数变成二次函数，所以只是多一次和树形 dp 麻烦一点的区别。

dp 具体方程就不列了，注意：算“……之和”和“……之方案数”的一般方法是一边和 \* 一边方案数。

## 图计数

$g(n,m)=\binom {\binom n2}m$。$f(n,m)$：$n$ 个点 $m$ 条边的答案。
$$
f(n,m)=g(n,m)-\sum_{i<n}\binom{n-1}{i-1}\sum_{j}f(i,j)g(n-i,m-j)
$$
直接 dp 是 $O(n^3\times n^3)=O(n^6)$ 的。

如果把 $f(n,*),g(n,*)$ 看成一个多项式，求出某个数代进去的值怎么算呢？实际上，上面的式子就是 $F_n(x)=G_n(x)-\sum_{i<n}\binom{n-1}{i-1}F_i(x)G_{n-i}(x)$，而 $G_i(x)=\sum_{i=0}^U \binom{U}ix^i$ 可以二项式定理预处理，每个代入的 $x$ dp 是 $O(n^2)$，总共带入 $O(n^2)$ 个 $x$，插值回来是 $O((n^2)^2)=O(n^4)$，所以每一步都是 $O(n^4)$。

## CF622F

略。

## P4464

不妨假设 $\sum_{1\le i\le n}i^y=\sum_{0\le i\le y+1}a_in^i$。
$$
\sum_{i\le n}i^yn^y(i,n)^{x-y}
\\
=n^y\sum_{g|n}g^{x-y}\sum_{i\le n}[(i,n)=g]i^y\\
=n^y\sum_{g|n}g^{x}\sum_{i\le n/g}[(i,n/g)=1]i^y\\
=n^y\sum_{g|n}g^{x}\sum_{dg|n}\mu(d)\sum_{i\le n/g,d|i}i^y\\
=n^y\sum_{g|n}g^{x}\sum_{dg|n}\mu(d)d^y\sum_{i\le n/gd}i^y\\
=n^y\sum_{g|n}g^{x}\sum_{dg|n}\mu(d)d^y\sum_{k}a_k(n/gd)^k\\
=n^y\sum_{k}a_k(id^x*(\mu\cdot id^y)*(id^k))(n)
$$
积性函数都很容易算单点值的！

- $h=(f*g)$ 表示 $h$ 是 $f,g$ 的狄利克雷卷积。
- $h=(f\cdot g)$ 表示 $h(x)=f(x)g(x)$。
- $h=f^k$ 表示 $h(x)=(f(x)*f(x)*\dots*f(x))$，共卷积 $k$ 次。
- $\epsilon$ 或者 $\iota$ 表示这样一个函数：$\iota(x)=[x=1]$。
- $id​$ 表示这样一个函数：$id(n)=n​$。
- $1$ 表示这样一个函数：$1=id^0$。
- $f^{-1}$ 定义为 $(f*f^{-1})=\epsilon$。
- $\mu=1^{-1}$。
- $\sigma_k(x)=\sum_{d|x}d^k$。
- $\varphi(x)=\sum_{1\le d\le x}[(d,x)=1]$。

